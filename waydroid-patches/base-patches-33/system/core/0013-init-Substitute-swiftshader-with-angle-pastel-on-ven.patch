From 99b2d610ccfb9704bc7c4dd1a57eced6d80dd0c7 Mon Sep 17 00:00:00 2001
From: Alessandro Astone <ales.astone@gmail.com>
Date: Thu, 23 Jan 2025 22:16:47 +0100
Subject: [PATCH 13/13] init: Substitute swiftshader with angle+pastel on
 vendor>=33

Vendor 33 does not include a swiftshader OpenGL driver anymore;
instead, the intended replacement is to use the swiftshader Vulkan
driver called "pastel", with the ANGLE translator.

Change-Id: Ibd998b56481992b641a34551ea05adf959c70f8f
---
 init/property_service.cpp | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/init/property_service.cpp b/init/property_service.cpp
index d6335b1fc..fcd35f849 100644
--- a/init/property_service.cpp
+++ b/init/property_service.cpp
@@ -1126,6 +1126,14 @@ void PropertyLoadBootDefaults() {
     load_properties_from_partition("odm", /* support_legacy_path_until */ 28);
     load_properties_from_partition("product", /* support_legacy_path_until */ 30);
 
+    if (int vendor; ParseInt(properties["ro.vendor.build.version.sdk"], &vendor) &&
+        vendor >= 33) {
+        if (properties["ro.hardware.egl"] == "swiftshader") {
+            properties["ro.hardware.egl"] = "angle";
+            properties["ro.hardware.vulkan"] = "pastel";
+        }
+    }
+
     if (access(kDebugRamdiskProp, R_OK) == 0) {
         LOG(INFO) << "Loading " << kDebugRamdiskProp;
         load_properties_from_file(kDebugRamdiskProp, nullptr, &properties);
-- 
2.48.1

